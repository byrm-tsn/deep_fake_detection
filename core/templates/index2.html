{% extends 'base2.html' %}
{% load static %}
{% block content %}
<div class="main-container">
  <div class="heading">
    <p>Deep Fake <br /><span id="auto-anim"></span></p>
  </div>

  <div class="video-container py-4 px-5">
    <p class="video-container-heading my-1">
      Verify the Authenticity of your Video
    </p>
    <p class="video-upload-desc my-3">
      Select a video file and Click <span>Upload</span> to determine if it is a
      DeepFake
    </p>

    <!-- Video upload form -->
    <form
      class="form_class"
      method="post"
      enctype="multipart/form-data"
      id="uploadForm"
      style="display: flex; flex-direction: column; align-items: center;"
    >
      {% csrf_token %}
      <div class="mb-3" style="width: 100%; max-width: 400px;">
        <input
          class="form-control"
          type="file"
          class="custom-file-input"
          id="my-file"
          name="uploaded_file"
          accept=".mp4"
          required
        />
      </div>
      <div
        id="message"
        style="display: none; font-size: 20px; text-align: center; height: 30px;"
        class="my-3"
      ></div>
      <div id="progress-bar" style="display: none; width: 100%; max-width: 400px;" class="my-3">
        <div class="progress">
          <div
            class="progress-bar"
            role="progressbar"
            style="
              width: 0%;
              height: 30px;
              margin-bottom: 10px;
              background-color: #ff0000;
            "
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            0%
          </div>
        </div>
      </div>

      <div id="processing-message" style="display: none; font-size: 20px; text-align: center;" class="my-3">
        Processing...
      </div>

      <button type="submit" class="video-upload-btn" style="width: 100%; max-width: 200px; margin-top: 10px;">Upload</button>
    </form>
  </div>
</div>

<!-- Typed.js for animated text -->
<script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
  // Initialize Typed.js animation on page load
  document.addEventListener("DOMContentLoaded", function () {
    const typed = new Typed("#auto-anim", {
      strings: ["Detector", "Video Detection"],
      typeSpeed: 100,
      backSpeed: 100,
      loop: true,
    });
  });

  // Validate file type on file input change
  document.getElementById("my-file").addEventListener("change", function () {
    var file = this.files[0];
    var fileType = file.name.split(".").pop().toLowerCase();

    if (fileType !== "mp4") {
      alert("File format not supported. Please upload an MP4 file.");
      this.value = "";
    }
  });

  // Handle form submission with AJAX
  document.getElementById("uploadForm").addEventListener("submit", function (e) {
    e.preventDefault();

    var formData = new FormData(this);
    var progressBar = document.getElementById("progress-bar");
    var progressBarInner = progressBar.querySelector('.progress-bar');
    var processingMessage = document.getElementById("processing-message");
    var messageDiv = document.getElementById("message");
    var uploadButton = document.querySelector(".video-upload-btn");
    var fileInput = document.getElementById("my-file");

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "{% url 'upload_video' %}", true);  // URL for upload
    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");

    xhr.upload.onprogress = function (e) {
      if (e.lengthComputable) {
        var percentComplete = (e.loaded / e.total) * 100;
        progressBarInner.style.width = percentComplete + "%";
        progressBarInner.textContent = percentComplete.toFixed(0) + "%";
      }
    };

    xhr.onloadstart = function (e) {
      progressBar.style.display = "block";
      uploadButton.disabled = true; // Disable the upload button
    };

    xhr.onloadend = function (e) {
      progressBar.style.display = "none";

      // Once upload is done, initiate the processing
      if (xhr.status === 200) {
        var response = JSON.parse(xhr.responseText);
        if (response.status === "success") {
          processVideo(response.file_path);  // Pass the uploaded file path for processing
        } else {
          alert("Upload failed.");
          uploadButton.disabled = false; // Enable the upload button
        }
      } else {
        alert("Upload failed.");
        uploadButton.disabled = false; // Enable the upload button
      }
    };

    xhr.onerror = function () {
      alert("Error occurred while uploading the file.");
      uploadButton.disabled = false; // Enable the upload button
    };

    xhr.send(formData);
  });

  // Process the uploaded video
  function processVideo(filePath) {
    var processingMessage = document.getElementById("processing-message");
    processingMessage.style.display = "block"; // Show the processing message

    var xhr = new XMLHttpRequest();
    xhr.open("POST", "{% url 'process_video' %}", true);  // URL for processing
    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onload = function () {
      var response = JSON.parse(xhr.responseText);
      var messageDiv = document.getElementById("message");
      var uploadButton = document.querySelector(".video-upload-btn");

      if (response.status === "success") {
        messageDiv.textContent = response.message;
        if (response.message.includes("REAL")) {
          messageDiv.style.color = "green";
        } else {
          messageDiv.style.color = "red";
        }
        messageDiv.style.display = "block";
      } else {
        messageDiv.textContent = "Error: " + response.message;
        messageDiv.style.color = "red";
        messageDiv.style.display = "block";
      }

      processingMessage.style.display = "none"; // Hide the processing message
      uploadButton.disabled = false; // Enable the upload button

      // Hide the message after 15 seconds
      setTimeout(function () {
        messageDiv.style.display = "none";
      }, 15000);
    };

    xhr.onerror = function () {
      alert("Error occurred while processing the video.");
      var uploadButton = document.querySelector(".video-upload-btn");

      processingMessage.style.display = "none"; // Hide the processing message
      uploadButton.disabled = false; // Enable the upload button
    };

    xhr.send(JSON.stringify({ file_path: filePath }));
  }
</script>

{% endblock %}
